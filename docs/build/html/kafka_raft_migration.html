

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Migrating from Kafka to Raft &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="hyperledger-fabricdocs master documentation" href="index.html"/>
        <link rel="up" title="Operations Guides" href="ops_guide.html"/>
        <link rel="next" title="Bringing up a Kafka-based Ordering Service" href="kafka.html"/>
        <link rel="prev" title="Configuring and operating a Raft ordering service" href="raft_configuration.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          


          
            <a href="index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<br><img style="background-color: #fff; height: unset; width: unset;" alt="Hyperledger Fabric" src=_images/hyperledger_fabric_logo_color.png />
<br>
<a href="https://github.com/hyperledger/fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="GitHub" src="_static/images/github_button.png"/></a>
&nbsp;<a href="https://stackoverflow.com/questions/tagged/hyperledger-fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="StackOverflow" src="_static/images/stackoverflow_button.png"/></a>
&nbsp;<a href="https://chat.hyperledger.org"><img style="padding: 0px; margin: auto auto auto auto;" alt="Rocket Chat" src="_static/images/rocketchat_button.png"/></a>
&nbsp;<a href="https://www.youtube.com/playlist?list=PL0MZ85B_96CH7wvtrRzV7SvtRY0sI0DEg"><img style="padding: 0px; margin: auto auto auto auto;" alt="Youtube Channel" src="_static/images/youtube_button.png"/></a>

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whatis.html">Introdução</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html">What’s new in Hyperledger Fabric v2.x</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html#release-notes">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_concepts.html">Conceitos Chave</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="developapps/developing_applications.html">Developing Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_guide_overview.html">Deploying a production network</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="ops_guide.html">Operations Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="orderer_deploy.html">Setting up an ordering node</a></li>
<li class="toctree-l2"><a class="reference internal" href="msp.html">Membership Service Providers (MSP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="hsm.html">Using a Hardware Security Module (HSM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="configtx.html">Channel Configuration (configtx)</a></li>
<li class="toctree-l2"><a class="reference internal" href="endorsement-policies.html">Endorsement policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="pluggable_endorsement_and_validation.html">Pluggable transaction endorsement and validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="access_control.html">Access Control Lists (ACL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="idemix.html">MSP Implementation with Identity Mixer</a></li>
<li class="toctree-l2"><a class="reference internal" href="idemixgen.html">Identity Mixer MSP configuration generator (idemixgen)</a></li>
<li class="toctree-l2"><a class="reference internal" href="operations_service.html">The Operations Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics_reference.html">Metrics Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="cc_launcher.html">External Builders and Launchers</a></li>
<li class="toctree-l2"><a class="reference internal" href="cc_service.html">Chaincode as an external service</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html">Error handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging-control.html">Logging Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="enable_tls.html">Securing Communication With Transport Layer Security (TLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="raft_configuration.html">Configuring and operating a Raft ordering service</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Migrating from Kafka to Raft</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#assumptions-and-considerations">Assumptions and considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#high-level-migration-flow">High level migration flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preparing-to-migrate">Preparing to migrate</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#entry-to-maintenance-mode">Entry to maintenance mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#switch-to-raft-in-maintenance-mode">Switch to Raft in maintenance mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#switch-out-of-maintenance-mode">Switch out of maintenance mode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#abort-and-rollback">Abort and rollback</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="kafka.html">Bringing up a Kafka-based Ordering Service</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">Upgrading to the latest release</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_ref.html">Commands Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fabric-FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributions Welcome!</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="questions.html">Still Have Questions?</a></li>
<li class="toctree-l1"><a class="reference internal" href="status.html">Status</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperledger-fabricdocs</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="ops_guide.html">Operations Guides</a> &raquo;</li>
        
      <li>Migrating from Kafka to Raft</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/kafka_raft_migration.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="migrating-from-kafka-to-raft">
<span id="migrating-from-kafka-to-raft"></span><h1>Migrating from Kafka to Raft<a class="headerlink" href="#migrating-from-kafka-to-raft" title="Permalink to this headline">¶</a></h1>
<p><strong>Note: this document presumes a high degree of expertise with channel
configuration update transactions. As the process for migration involves
several channel configuration update transactions, do not attempt to migrate
from Kafka to Raft without first familiarizing yourself with the <a class="reference external" href="channel_update_tutorial.html">Add an
Organization to a Channel</a> tutorial, which
describes the channel update process in detail.</strong></p>
<p>For users who want to transition channels from using Kafka-based ordering
services to <a class="reference external" href="./orderer/ordering_service.html#Raft">Raft-based</a> ordering services,
nodes at v1.4.2 or higher allow this to be accomplished through a series of configuration update
transactions on each channel in the network.</p>
<p>This tutorial will describe this process at a high level, calling out specific
details where necessary, rather than show each command in detail.</p>
<div class="section" id="assumptions-and-considerations">
<span id="assumptions-and-considerations"></span><h2>Assumptions and considerations<a class="headerlink" href="#assumptions-and-considerations" title="Permalink to this headline">¶</a></h2>
<p>Before attempting migration, take the following into account:</p>
<ol class="simple">
<li>This process is solely for migration from Kafka to Raft. Migrating between
any other orderer consensus types is not currently supported.</li>
<li>Migration is one way. Once the ordering service is migrated to Raft, and
starts committing transactions, it is not possible to go back to Kafka.</li>
<li>Because the ordering nodes must go down and be brought back up, downtime must
be allowed during the migration.</li>
<li>Recovering from a botched migration is possible only if a backup is taken at
the point in migration prescribed later in this document. If you do not take a
backup, and migration fails, you will not be able to recover your previous state.</li>
<li>All channels must be migrated during the same maintenance window. It is not
possible to migrate only some channels before resuming operations.</li>
<li>At the end of the migration process, every channel will have the same
consenter set of Raft nodes. This is the same consenter set that will exist in
the ordering system channel. This makes it possible to diagnose a successful
migration.</li>
<li>Migration is done in place, utilizing the existing ledgers for the deployed
ordering nodes. Addition or removal of orderers should be performed after the
migration.</li>
</ol>
</div>
<div class="section" id="high-level-migration-flow">
<span id="high-level-migration-flow"></span><h2>High level migration flow<a class="headerlink" href="#high-level-migration-flow" title="Permalink to this headline">¶</a></h2>
<p>Migration is carried out in five phases.</p>
<ol class="simple">
<li>The system is placed into a maintenance mode where application transactions
are rejected and only ordering service admins can make changes to the channel
configuration.</li>
<li>The system is stopped, and a backup is taken in case an error occurs during
migration.</li>
<li>The system is started, and each channel has its consensus type and metadata
modified.</li>
<li>The system is restarted and is now operating on Raft consensus; each channel
is checked to confirm that it has successfully achieved a quorum.</li>
<li>The system is moved out of maintenance mode and normal function resumes.</li>
</ol>
</div>
<div class="section" id="preparing-to-migrate">
<span id="preparing-to-migrate"></span><h2>Preparing to migrate<a class="headerlink" href="#preparing-to-migrate" title="Permalink to this headline">¶</a></h2>
<p>There are several steps you should take before attempting to migrate.</p>
<ul class="simple">
<li>Design the Raft deployment, deciding which ordering service nodes are going to
remain as Raft consenters. You should deploy at least three ordering nodes in
your cluster, but note that deploying a consenter set of at least five nodes
will maintain high availability should a node goes down, whereas a three node
configuration will lose high availability once a single node goes down for any
reason (for example, as during a maintenance cycle).</li>
<li>Prepare the material for
building the Raft <code class="docutils literal notranslate"><span class="pre">Metadata</span></code> configuration. <strong>Note: all the channels should receive
the same Raft <code class="docutils literal notranslate"><span class="pre">Metadata</span></code> configuration</strong>. Refer to the <a class="reference external" href="raft_configuration.html">Raft configuration guide</a>
for more information on these fields. Note: you may find it easiest to bootstrap
a new ordering network with the Raft consensus protocol, then copy and modify
the consensus metadata section from its config. In any case, you will need
(for each ordering node):<ul>
<li><code class="docutils literal notranslate"><span class="pre">hostname</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">port</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">server</span> <span class="pre">certificate</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">client</span> <span class="pre">certificate</span></code></li>
</ul>
</li>
<li>Compile a list of all channels (system and application) in the system. Make
sure you have the correct credentials to sign the configuration updates. For
example, the relevant ordering service admin identities.</li>
<li>Ensure all ordering service nodes are running the same version of Fabric, and
that this version is v1.4.2 or greater.</li>
<li>Ensure all peers are running at least v1.4.2 of Fabric. Make sure all channels
are configured with the channel capability that enables migration.<ul>
<li>Orderer capability <code class="docutils literal notranslate"><span class="pre">V1_4_2</span></code> (or above).</li>
<li>Channel capability <code class="docutils literal notranslate"><span class="pre">V1_4_2</span></code> (or above).</li>
</ul>
</li>
</ul>
<div class="section" id="entry-to-maintenance-mode">
<span id="entry-to-maintenance-mode"></span><h3>Entry to maintenance mode<a class="headerlink" href="#entry-to-maintenance-mode" title="Permalink to this headline">¶</a></h3>
<p>Prior to setting the ordering service into maintenance mode, it is recommended
that the peers and clients of the network be stopped. Leaving peers or clients
up and running is safe, however, because the ordering service will reject all of
their requests, their logs will fill with benign but misleading failures.</p>
<p>Follow the process in the <a class="reference external" href="channel_update_tutorial.html">Add an Organization to a Channel</a>
tutorial to pull, translate, and scope the configuration of <strong>each channel,
starting with the system channel</strong>. The only field you should change during
this step is in the channel configuration at <code class="docutils literal notranslate"><span class="pre">/Channel/Orderer/ConsensusType</span></code>.
In a JSON representation of the channel configuration, this would be
<code class="docutils literal notranslate"><span class="pre">.channel_group.groups.Orderer.values.ConsensusType​</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ConsensusType</span></code> is represented by three values: <code class="docutils literal notranslate"><span class="pre">Type</span></code>, <code class="docutils literal notranslate"><span class="pre">Metadata</span></code>, and
<code class="docutils literal notranslate"><span class="pre">State</span></code>, where:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Type</span></code> is either <code class="docutils literal notranslate"><span class="pre">kafka</span></code> or <code class="docutils literal notranslate"><span class="pre">etcdraft</span></code> (Raft). This value can only be
changed while in maintenance mode.</li>
<li><code class="docutils literal notranslate"><span class="pre">Metadata</span></code> will be empty if the <code class="docutils literal notranslate"><span class="pre">Type</span></code> is kafka, but must carry valid Raft
metadata if the <code class="docutils literal notranslate"><span class="pre">ConsensusType</span></code> is <code class="docutils literal notranslate"><span class="pre">etcdraft</span></code>. More on this below.</li>
<li><code class="docutils literal notranslate"><span class="pre">State</span></code> is either <code class="docutils literal notranslate"><span class="pre">STATE_NORMAL</span></code>, when the channel is processing transactions, or
<code class="docutils literal notranslate"><span class="pre">STATE_MAINTENANCE</span></code>, during the migration process.</li>
</ul>
<p>In the first step of the channel configuration update, only change the <code class="docutils literal notranslate"><span class="pre">State</span></code>
from <code class="docutils literal notranslate"><span class="pre">STATE_NORMAL</span></code> to <code class="docutils literal notranslate"><span class="pre">STATE_MAINTENANCE</span></code>. Do not change the <code class="docutils literal notranslate"><span class="pre">Type</span></code> or the <code class="docutils literal notranslate"><span class="pre">Metadata</span></code> field
yet. Note that the <code class="docutils literal notranslate"><span class="pre">Type</span></code> should currently be <code class="docutils literal notranslate"><span class="pre">kafka</span></code>.</p>
<p>While in maintenance mode, normal transactions, config updates unrelated to
migration, and <code class="docutils literal notranslate"><span class="pre">Deliver</span></code> requests from the peers used to retrieve new blocks are
rejected. This is done in order to prevent the need to both backup, and if
necessary restore, peers during migration, as they only receive updates once
migration has successfully completed. In other words, we want to keep the
ordering service backup point, which is the next step, ahead of the peer’s ledger,
in order to be able to perform rollback if needed. However, ordering node admins
can issue <code class="docutils literal notranslate"><span class="pre">Deliver</span></code> requests (which they need to be able to do in order to
continue the migration process).</p>
<p><strong>Verify</strong> that each ordering service node has entered maintenance mode on each
of the channels. This can be done by fetching the last config block and making
sure that the <code class="docutils literal notranslate"><span class="pre">Type</span></code>, <code class="docutils literal notranslate"><span class="pre">Metadata</span></code>, <code class="docutils literal notranslate"><span class="pre">State</span></code> on each channel is <code class="docutils literal notranslate"><span class="pre">kafka</span></code>, empty
(recall that there is no metadata for Kafka), and <code class="docutils literal notranslate"><span class="pre">STATE_MAINTENANCE</span></code>, respectively.</p>
<p>If the channels have been updated successfully, the ordering service is now
ready for backup.</p>
<div class="section" id="backup-files-and-shut-down-servers">
<span id="backup-files-and-shut-down-servers"></span><h4>Backup files and shut down servers<a class="headerlink" href="#backup-files-and-shut-down-servers" title="Permalink to this headline">¶</a></h4>
<p>Shut down all ordering nodes, Kafka servers, and Zookeeper servers. It is
important to <strong>shutdown the ordering service nodes first</strong>. Then, after allowing
the Kafka service to flush its logs to disk (this typically takes about 30
seconds, but might take longer depending on your system), the Kafka servers
should be shut down. Shutting down the Kafka brokers at the same time as the
orderers can result in the filesystem state of the orderers being more recent
than the Kafka brokers which could prevent your network from starting.</p>
<p>Create a backup of the file system of these servers. Then restart the Kafka
service and then the ordering service nodes.</p>
</div>
</div>
<div class="section" id="switch-to-raft-in-maintenance-mode">
<span id="switch-to-raft-in-maintenance-mode"></span><h3>Switch to Raft in maintenance mode<a class="headerlink" href="#switch-to-raft-in-maintenance-mode" title="Permalink to this headline">¶</a></h3>
<p>The next step in the migration process is another channel configuration update
for each channel. In this configuration update, switch the <code class="docutils literal notranslate"><span class="pre">Type</span></code> to <code class="docutils literal notranslate"><span class="pre">etcdraft</span></code>
(for Raft) while keeping the <code class="docutils literal notranslate"><span class="pre">State</span></code> in <code class="docutils literal notranslate"><span class="pre">STATE_MAINTENANCE</span></code>, and fill in the
<code class="docutils literal notranslate"><span class="pre">Metadata</span></code> configuration​. It is highly recommended that the <code class="docutils literal notranslate"><span class="pre">Metadata</span></code> configuration​ be
identical​ on all channels. If you want to establish different consenter sets
with different nodes, you will be able to reconfigure the <code class="docutils literal notranslate"><span class="pre">Metadata</span></code> configuration​
after the system is restarted into <code class="docutils literal notranslate"><span class="pre">etcdraft</span></code> mode. Supplying an identical metadata
object, and hence, an identical consenter set, means that when the nodes are
restarted, if the system channel forms a quorum and can exit maintenance mode,
other channels will likely be able do the same. Supplying different consenter
sets to each channel can cause one channel to succeed in forming a cluster while
another channel will fail.</p>
<p>Then, validate that each ordering service node has committed the <code class="docutils literal notranslate"><span class="pre">ConsensusType</span></code>
change configuration update by pulling and inspecting the configuration of each
channel.</p>
<p>Note: For each channel, the transaction that changes the <code class="docutils literal notranslate"><span class="pre">ConsensusType</span></code> must be the last
configuration transaction before restarting the nodes (in the next step). If
some other configuration transaction happens after this step, the nodes will
most likely crash on restart, or result in undefined behavior.</p>
<div class="section" id="restart-and-validate-leader">
<span id="restart-and-validate-leader"></span><h4>Restart and validate leader<a class="headerlink" href="#restart-and-validate-leader" title="Permalink to this headline">¶</a></h4>
<p>Note: exit of maintenance mode <strong>must</strong> be done <strong>after</strong> restart.</p>
<p>After the <code class="docutils literal notranslate"><span class="pre">ConsensusType</span></code> update has been completed on each channel, stop all
ordering service nodes, stop all Kafka brokers and Zookeepers, and then restart
only the ordering service nodes. They should restart as Raft nodes, form a cluster per
channel, and elect a leader on each channel.</p>
<p><strong>Note</strong>: Since the Raft-based ordering service uses client and server TLS certificates for
authentication between orderer nodes, <strong>additional configurations</strong> are required before
you start them again, see
<a class="reference external" href="./raft_configuration.md#local-configuration">Section: Local Configuration</a> for more details.</p>
<p>After restart process finished, make sure to <strong>validate</strong> that a
leader has been elected on each channel by inspecting the node logs (you can see
what to look for below). This will confirm that the process has been completed
successfully.</p>
<p>When a leader is elected, the log will show, for each channel:</p>
<div class="highlight-​ notranslate"><div class="highlight"><pre><span></span>&quot;Raft leader changed: 0 -&gt; ​node-number​ ​channel=​channel-name​
node=​node-number​ ​&quot;
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2019</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">26</span> <span class="mi">10</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">44.075</span> <span class="n">UTC</span> <span class="p">[</span><span class="n">orderer</span><span class="o">.</span><span class="n">consensus</span><span class="o">.</span><span class="n">etcdraft</span><span class="p">]</span> <span class="n">serveRequest</span> <span class="o">-&gt;</span>
<span class="n">INFO</span> <span class="mi">047</span> <span class="n">Raft</span> <span class="n">leader</span> <span class="n">changed</span><span class="p">:</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="mi">1</span> <span class="n">channel</span><span class="o">=</span><span class="n">testchannel1</span> <span class="n">node</span><span class="o">=</span><span class="mi">2</span>
</pre></div>
</div>
<p>In this example <code class="docutils literal notranslate"><span class="pre">​node</span> <span class="pre">2​</span></code> reports that a leader was elected (the leader is
​<code class="docutils literal notranslate"><span class="pre">node</span> <span class="pre">1</span></code>​) by the cluster of channel <code class="docutils literal notranslate"><span class="pre">​testchannel1​</span></code>.</p>
</div>
</div>
<div class="section" id="switch-out-of-maintenance-mode">
<span id="switch-out-of-maintenance-mode"></span><h3>Switch out of maintenance mode<a class="headerlink" href="#switch-out-of-maintenance-mode" title="Permalink to this headline">¶</a></h3>
<p>Perform another channel configuration update on each channel (sending the config
update to the same ordering node you have been sending configuration updates to
until now), switching the <code class="docutils literal notranslate"><span class="pre">State</span></code> from <code class="docutils literal notranslate"><span class="pre">STATE_MAINTENANCE</span></code> to <code class="docutils literal notranslate"><span class="pre">STATE_NORMAL</span></code>. Start with the
system channel, as usual. If it succeeds on the ordering system channel,
migration is likely to succeed on all channels. To verify, fetch the last config
block of the system channel from the ordering node, verifying that the <code class="docutils literal notranslate"><span class="pre">State</span></code>
is now <code class="docutils literal notranslate"><span class="pre">STATE_NORMAL</span></code>. For completeness, verify this on each ordering node.</p>
<p>When this process is completed, the ordering service is now ready to accept all
transactions on all channels. If you stopped your peers and application as
recommended, you may now restart them.</p>
</div>
</div>
<div class="section" id="abort-and-rollback">
<span id="abort-and-rollback"></span><h2>Abort and rollback<a class="headerlink" href="#abort-and-rollback" title="Permalink to this headline">¶</a></h2>
<p>If a problem emerges during the migration process <strong>before exiting maintenance
mode</strong>, simply perform the rollback procedure below.</p>
<ol class="simple">
<li>Shut down the ordering nodes and the Kafka service (servers and Zookeeper
ensemble).</li>
<li>Rollback the file system of these servers to the backup taken at maintenance
mode before changing the <code class="docutils literal notranslate"><span class="pre">ConsensusType</span></code>.</li>
<li>Restart said servers, the ordering nodes will bootstrap to Kafka in
maintenance mode.</li>
<li>Send a configuration update exiting maintenance mode to continue using Kafka
as your consensus mechanism, or resume the instructions after the point of
backup and fix the error which prevented a Raft quorum from forming and retry
migration with corrected Raft configuration <code class="docutils literal notranslate"><span class="pre">Metadata</span></code>.</li>
</ol>
<p>There are a few states which might indicate migration has failed:</p>
<ol class="simple">
<li>Some nodes crash or shutdown.</li>
<li>There is no record of a successful leader election per channel in the logs.</li>
<li>The attempt to flip to <code class="docutils literal notranslate"><span class="pre">STATE_NORMAL</span></code> mode on the system channel fails.</li>
</ol>
<!--- Licensed under Creative Commons Attribution 4.0 International License
https://creativecommons.org/licenses/by/4.0/) --></div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="kafka.html" class="btn btn-neutral float-right" title="Bringing up a Kafka-based Ordering Service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="raft_configuration.html" class="btn btn-neutral" title="Configuring and operating a Raft ordering service" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2020.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'master',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>