

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>External Builders and Launchers &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="hyperledger-fabricdocs master documentation" href="index.html"/>
        <link rel="up" title="Operations Guides" href="ops_guide.html"/>
        <link rel="next" title="Chaincode as an external service" href="cc_service.html"/>
        <link rel="prev" title="Metrics Reference" href="metrics_reference.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          


          
            <a href="index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<br><img style="background-color: #fff; height: unset; width: unset;" alt="Hyperledger Fabric" src=_images/hyperledger_fabric_logo_color.png />
<br>
<a href="https://github.com/hyperledger/fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="GitHub" src="_static/images/github_button.png"/></a>
&nbsp;<a href="https://stackoverflow.com/questions/tagged/hyperledger-fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="StackOverflow" src="_static/images/stackoverflow_button.png"/></a>
&nbsp;<a href="https://chat.hyperledger.org"><img style="padding: 0px; margin: auto auto auto auto;" alt="Rocket Chat" src="_static/images/rocketchat_button.png"/></a>
&nbsp;<a href="https://www.youtube.com/playlist?list=PL0MZ85B_96CH7wvtrRzV7SvtRY0sI0DEg"><img style="padding: 0px; margin: auto auto auto auto;" alt="Youtube Channel" src="_static/images/youtube_button.png"/></a>

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whatis.html">Introdução</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html">What’s new in Hyperledger Fabric v2.x</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html#release-notes">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_concepts.html">Principais Conceitos</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="developapps/developing_applications.html">Developing Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_guide_overview.html">Deploying a production network</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="ops_guide.html">Operations Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="orderer_deploy.html">Setting up an ordering node</a></li>
<li class="toctree-l2"><a class="reference internal" href="msp.html">Membership Service Providers (MSP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="hsm.html">Using a Hardware Security Module (HSM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="configtx.html">Channel Configuration (configtx)</a></li>
<li class="toctree-l2"><a class="reference internal" href="endorsement-policies.html">Endorsement policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="pluggable_endorsement_and_validation.html">Pluggable transaction endorsement and validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="access_control.html">Access Control Lists (ACL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="idemix.html">MSP Implementation with Identity Mixer</a></li>
<li class="toctree-l2"><a class="reference internal" href="idemixgen.html">Identity Mixer MSP configuration generator (idemixgen)</a></li>
<li class="toctree-l2"><a class="reference internal" href="operations_service.html">The Operations Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics_reference.html">Metrics Reference</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">External Builders and Launchers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#external-builder-model">External builder model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#external-builder-and-launcher-api">External builder and launcher API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-external-builders-and-launchers">Configuring external builders and launchers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#chaincode-packages">Chaincode packages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#lifecycle-chaincode-package-contents">Lifecycle chaincode package contents</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chaincode-packages-and-external-builders">Chaincode packages and external builders</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cc_service.html">Chaincode as an external service</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html">Error handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging-control.html">Logging Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="enable_tls.html">Securing Communication With Transport Layer Security (TLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="raft_configuration.html">Configuring and operating a Raft ordering service</a></li>
<li class="toctree-l2"><a class="reference internal" href="kafka_raft_migration.html">Migrating from Kafka to Raft</a></li>
<li class="toctree-l2"><a class="reference internal" href="kafka.html">Bringing up a Kafka-based Ordering Service</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">Upgrading to the latest release</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_ref.html">Commands Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fabric-FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributions Welcome!</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="questions.html">Still Have Questions?</a></li>
<li class="toctree-l1"><a class="reference internal" href="status.html">Status</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperledger-fabricdocs</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="ops_guide.html">Operations Guides</a> &raquo;</li>
        
      <li>External Builders and Launchers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/cc_launcher.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="external-builders-and-launchers">
<span id="external-builders-and-launchers"></span><h1>External Builders and Launchers<a class="headerlink" href="#external-builders-and-launchers" title="Permalink to this headline">¶</a></h1>
<p>Prior to Hyperledger Fabric 2.0, the process used to build and launch chaincode was part of the peer implementation and could not be easily customized. All chaincode installed on the peer would be “built” using language specific logic hard coded in the peer. This build process would generate a Docker container image that would be launched to execute chaincode that connected as a client to the peer.</p>
<p>This approach limited chaincode implementations to a handful of languages, required Docker to be part of the deployment environment, and prevented running chaincode as a long running server process.</p>
<p>Starting with Fabric 2.0, External Builders and Launchers address these limitations by enabling operators to extend the peer with programs that can build, launch, and discover chaincode. To leverage this capability you will need to create your own buildpack and then modify the peer core.yaml to include a new <code class="docutils literal notranslate"><span class="pre">externalBuilder</span></code> configuration element which lets the peer know an external builder is available. The following sections describe the details of this process.</p>
<p>Note that if no configured external builder claims a chaincode package, the peer will attempt to process the package as if it were created with the standard Fabric packaging tools such as the peer CLI or node SDK.</p>
<div class="section" id="external-builder-model">
<span id="external-builder-model"></span><h2>External builder model<a class="headerlink" href="#external-builder-model" title="Permalink to this headline">¶</a></h2>
<p>Hyperledger Fabric External Builders and Launchers are loosely based on Heroku <a class="reference external" href="https://devcenter.heroku.com/articles/buildpack-api">Buildpacks</a>. A buildpack implementation is simply a collection of programs or scripts that transform application artifacts into something that can run. The buildpack model has been adapted for chaincode packages and extended to support chaincode execution and discovery.</p>
<div class="section" id="external-builder-and-launcher-api">
<span id="external-builder-and-launcher-api"></span><h3>External builder and launcher API<a class="headerlink" href="#external-builder-and-launcher-api" title="Permalink to this headline">¶</a></h3>
<p>An external builder and launcher consists of four programs or scripts:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">bin/detect</span></code>: Determine whether or not this buildpack should be used to build the chaincode package and launch it.</li>
<li><code class="docutils literal notranslate"><span class="pre">bin/build</span></code>: Transform the chaincode package into executable chaincode.</li>
<li><code class="docutils literal notranslate"><span class="pre">bin/release</span></code> (optional): Provide metadata to the peer about the chaincode.</li>
<li><code class="docutils literal notranslate"><span class="pre">bin/run</span></code> (optional): Run the chaincode.</li>
</ul>
<div class="section" id="bin-detect">
<span id="bin-detect"></span><h4><code class="docutils literal notranslate"><span class="pre">bin/detect</span></code><a class="headerlink" href="#bin-detect" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">bin/detect</span></code> script is responsible for determining whether or not a buildpack should be used to build a chaincode package and launch it. The peer invokes <code class="docutils literal notranslate"><span class="pre">detect</span></code> with two arguments:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>bin/detect CHAINCODE_SOURCE_DIR CHAINCODE_METADATA_DIR
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">detect</span></code> is invoked, <code class="docutils literal notranslate"><span class="pre">CHAINCODE_SOURCE_DIR</span></code> contains the chaincode source and <code class="docutils literal notranslate"><span class="pre">CHAINCODE_METADATA_DIR</span></code> contains the <code class="docutils literal notranslate"><span class="pre">metadata.json</span></code> file from the chaincode package installed to the peer. The <code class="docutils literal notranslate"><span class="pre">CHAINCODE_SOURCE_DIR</span></code> and <code class="docutils literal notranslate"><span class="pre">CHAINCODE_METADATA_DIR</span></code> should be treated as read only inputs. If the buildpack should be applied to the chaincode source package, <code class="docutils literal notranslate"><span class="pre">detect</span></code> must return an exit code of <code class="docutils literal notranslate"><span class="pre">0</span></code>; any other exit code will indicate that the buildpack should not be applied.</p>
<p>The following is an example of a simple <code class="docutils literal notranslate"><span class="pre">detect</span></code> script for go chaincode:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">CHAINCODE_METADATA_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>

<span class="c1"># use jq to extract the chaincode type from metadata.json and exit with</span>
<span class="c1"># success if the chaincode type is golang</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="k">$(</span>jq -r .type <span class="s2">&quot;</span><span class="nv">$CHAINCODE_METADATA_DIR</span><span class="s2">/metadata.json&quot;</span> <span class="p">|</span> tr <span class="s1">&#39;[:upper:]&#39;</span> <span class="s1">&#39;[:lower:]&#39;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;golang&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">exit</span> 0
<span class="k">fi</span>

<span class="nb">exit</span> 1
</pre></div>
</div>
</div>
<div class="section" id="bin-build">
<span id="bin-build"></span><h4><code class="docutils literal notranslate"><span class="pre">bin/build</span></code><a class="headerlink" href="#bin-build" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">bin/build</span></code> script is responsible for building, compiling, or transforming the contents of a chaincode package into artifacts that can be used by <code class="docutils literal notranslate"><span class="pre">release</span></code> and <code class="docutils literal notranslate"><span class="pre">run</span></code>. The peer invokes <code class="docutils literal notranslate"><span class="pre">build</span></code> with three arguments:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>bin/build CHAINCODE_SOURCE_DIR CHAINCODE_METADATA_DIR BUILD_OUTPUT_DIR
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">build</span></code> is invoked, <code class="docutils literal notranslate"><span class="pre">CHAINCODE_SOURCE_DIR</span></code> contains the chaincode source and <code class="docutils literal notranslate"><span class="pre">CHAINCODE_METADATA_DIR</span></code> contains the <code class="docutils literal notranslate"><span class="pre">metadata.json</span></code> file from the chaincode package installed to the peer. <code class="docutils literal notranslate"><span class="pre">BUILD_OUTPUT_DIR</span></code> is the directory where <code class="docutils literal notranslate"><span class="pre">build</span></code> must place artifacts needed by <code class="docutils literal notranslate"><span class="pre">release</span></code> and <code class="docutils literal notranslate"><span class="pre">run</span></code>. The build script should treat the input directories <code class="docutils literal notranslate"><span class="pre">CHAINCODE_SOURCE_DIR</span></code> and <code class="docutils literal notranslate"><span class="pre">CHAINCODE_METADATA_DIR</span></code> as read only, but the <code class="docutils literal notranslate"><span class="pre">BUILD_OUTPUT_DIR</span></code> is writeable.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">build</span></code> completes with an exit code of <code class="docutils literal notranslate"><span class="pre">0</span></code>, the contents of <code class="docutils literal notranslate"><span class="pre">BUILD_OUTPUT_DIR</span></code> will be copied to the persistent storage maintained by the peer; any other exit code will be considered a failure.</p>
<p>The following is an example of a simple <code class="docutils literal notranslate"><span class="pre">build</span></code> script for go chaincode:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">CHAINCODE_SOURCE_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="nv">CHAINCODE_METADATA_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="nv">BUILD_OUTPUT_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>

<span class="c1"># extract package path from metadata.json</span>
<span class="nv">GO_PACKAGE_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>jq -r .path <span class="s2">&quot;</span><span class="nv">$CHAINCODE_METADATA_DIR</span><span class="s2">/metadata.json&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$CHAINCODE_SOURCE_DIR</span><span class="s2">/src/go.mod&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$CHAINCODE_SOURCE_DIR</span><span class="s2">/src&quot;</span>
    go build -v -mod<span class="o">=</span><span class="nb">readonly</span> -o <span class="s2">&quot;</span><span class="nv">$BUILD_OUTPUT_DIR</span><span class="s2">/chaincode&quot;</span> <span class="s2">&quot;</span><span class="nv">$GO_PACKAGE_PATH</span><span class="s2">&quot;</span>
<span class="k">else</span>
    <span class="nv">GO111MODULE</span><span class="o">=</span>off go build -v  -o <span class="s2">&quot;</span><span class="nv">$BUILD_OUTPUT_DIR</span><span class="s2">/chaincode&quot;</span> <span class="s2">&quot;</span><span class="nv">$GO_PACKAGE_PATH</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="c1"># save statedb index metadata to provide at release</span>
<span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;</span><span class="nv">$CHAINCODE_SOURCE_DIR</span><span class="s2">/META-INF&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    cp -a <span class="s2">&quot;</span><span class="nv">$CHAINCODE_SOURCE_DIR</span><span class="s2">/META-INF&quot;</span> <span class="s2">&quot;</span><span class="nv">$BUILD_OUTPUT_DIR</span><span class="s2">/&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
<div class="section" id="bin-release">
<span id="bin-release"></span><h4><code class="docutils literal notranslate"><span class="pre">bin/release</span></code><a class="headerlink" href="#bin-release" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">bin/release</span></code> script is responsible for providing chaincode metadata to the peer. <code class="docutils literal notranslate"><span class="pre">bin/release</span></code> is optional. If it is not provided, this step is skipped. The peer invokes <code class="docutils literal notranslate"><span class="pre">release</span></code> with two arguments:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>bin/release BUILD_OUTPUT_DIR RELEASE_OUTPUT_DIR
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">release</span></code> is invoked, <code class="docutils literal notranslate"><span class="pre">BUILD_OUTPUT_DIR</span></code> contains the artifacts populated by the <code class="docutils literal notranslate"><span class="pre">build</span></code> program and should be treated as read only input. <code class="docutils literal notranslate"><span class="pre">RELEASE_OUTPUT_DIR</span></code> is the directory where <code class="docutils literal notranslate"><span class="pre">release</span></code> must place artifacts to be consumed by the peer.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">release</span></code> completes, the peer will consume two types of metadata from <code class="docutils literal notranslate"><span class="pre">RELEASE_OUTPUT_DIR</span></code>:</p>
<ul class="simple">
<li>state database index definitions for CouchDB</li>
<li>external chaincode server connection information (<code class="docutils literal notranslate"><span class="pre">chaincode/server/connection.json</span></code>)</li>
</ul>
<p>If CouchDB index definitions are required for the chaincode, <code class="docutils literal notranslate"><span class="pre">release</span></code> is responsible for placing the indexes into the <code class="docutils literal notranslate"><span class="pre">statedb/couchdb/indexes</span></code> directory under <code class="docutils literal notranslate"><span class="pre">RELEASE_OUTPUT_DIR</span></code>. The indexes must have a <code class="docutils literal notranslate"><span class="pre">.json</span></code> extension.  See the <a class="reference external" href="couchdb_as_state_database.html#couchdb-indexes">CouchDB indexes</a> documentation for details.</p>
<p>In cases where a chaincode server implementation is used, <code class="docutils literal notranslate"><span class="pre">release</span></code> is responsible for populating <code class="docutils literal notranslate"><span class="pre">chaincode/server/connection.json</span></code> with the address of the chaincode server and any TLS assets required to communicate with the chaincode. When server connection information is provided to the peer, <code class="docutils literal notranslate"><span class="pre">run</span></code> will not be called. See the <a class="reference external" href="https://jira.hyperledger.org/browse/FAB-14086">Chaincode Server</a> documentation for details.</p>
<p>The following is an example of a simple <code class="docutils literal notranslate"><span class="pre">release</span></code> script for go chaincode:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">BUILD_OUTPUT_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="nv">RELEASE_OUTPUT_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>

<span class="c1"># copy indexes from META-INF/* to the output directory</span>
<span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;</span><span class="nv">$BUILD_OUTPUT_DIR</span><span class="s2">/META-INF&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
   cp -a <span class="s2">&quot;</span><span class="nv">$BUILD_OUTPUT_DIR</span><span class="s2">/META-INF/&quot;</span>* <span class="s2">&quot;</span><span class="nv">$RELEASE_OUTPUT_DIR</span><span class="s2">/&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
<div class="section" id="bin-run">
<span id="bin-run"></span><h4><code class="docutils literal notranslate"><span class="pre">bin/run</span></code><a class="headerlink" href="#bin-run" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">bin/run</span></code> script is responsible for running chaincode. The peer invokes <code class="docutils literal notranslate"><span class="pre">run</span></code> with two arguments:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>bin/run BUILD_OUTPUT_DIR RUN_METADATA_DIR
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">run</span></code> is called, <code class="docutils literal notranslate"><span class="pre">BUILD_OUTPUT_DIR</span></code> contains the artifacts populated by the <code class="docutils literal notranslate"><span class="pre">build</span></code> program and <code class="docutils literal notranslate"><span class="pre">RUN_METADATA_DIR</span></code> is populated with a file called <code class="docutils literal notranslate"><span class="pre">chaincode.json</span></code> that contains the information necessary for chaincode to connect and register with the peer. Note that the <code class="docutils literal notranslate"><span class="pre">bin/run</span></code> script should treat these <code class="docutils literal notranslate"><span class="pre">BUILD_OUTPUT_DIR</span></code> and <code class="docutils literal notranslate"><span class="pre">RUN_METADATA_DIR</span></code> directories as read only input.  The keys included in <code class="docutils literal notranslate"><span class="pre">chaincode.json</span></code> are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">chaincode_id</span></code>: The unique ID associated with the chaincode package.</li>
<li><code class="docutils literal notranslate"><span class="pre">peer_address</span></code>: The address in <code class="docutils literal notranslate"><span class="pre">host:port</span></code> format of the <code class="docutils literal notranslate"><span class="pre">ChaincodeSupport</span></code> gRPC server endpoint hosted by the peer.</li>
<li><code class="docutils literal notranslate"><span class="pre">client_cert</span></code>: The PEM encoded TLS client certificate generated by the peer that must be used when the chaincode establishes its connection to the peer.</li>
<li><code class="docutils literal notranslate"><span class="pre">client_key</span></code>: The PEM encoded client key generated by the peer that must be used when the chaincode establishes its connection to the peer.</li>
<li><code class="docutils literal notranslate"><span class="pre">root_cert</span></code>: The PEM encoded TLS root certificate for the <code class="docutils literal notranslate"><span class="pre">ChaincodeSupport</span></code> gRPC server endpoint hosted by the peer.</li>
<li><code class="docutils literal notranslate"><span class="pre">mspid</span></code>: The local mspid of the peer.</li>
</ul>
<p>When <code class="docutils literal notranslate"><span class="pre">run</span></code> terminates, the peer considers the chaincode terminated. If another request arrives for the chaincode, the peer will attempt to start another instance of the chaincode by invoking <code class="docutils literal notranslate"><span class="pre">run</span></code> again. The contents of <code class="docutils literal notranslate"><span class="pre">chaincode.json</span></code> must not be cached across invocations.</p>
<p>The following is an example of a simple <code class="docutils literal notranslate"><span class="pre">run</span></code> script for go chaincode:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">BUILD_OUTPUT_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="nv">RUN_METADATA_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>

<span class="c1"># setup the environment expected by the go chaincode shim</span>
<span class="nb">export</span> <span class="nv">CORE_CHAINCODE_ID_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>jq -r .chaincode_id <span class="s2">&quot;</span><span class="nv">$RUN_METADATA_DIR</span><span class="s2">/chaincode.json&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ENABLED</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_TLS_CLIENT_CERT_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$RUN_METADATA_DIR</span><span class="s2">/client.crt&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_TLS_CLIENT_KEY_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$RUN_METADATA_DIR</span><span class="s2">/client.key&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$RUN_METADATA_DIR</span><span class="s2">/root.crt&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>jq -r .mspid <span class="s2">&quot;</span><span class="nv">$RUN_METADATA_DIR</span><span class="s2">/chaincode.json&quot;</span><span class="k">)</span><span class="s2">&quot;</span>

<span class="c1"># populate the key and certificate material used by the go chaincode shim</span>
jq -r .client_cert <span class="s2">&quot;</span><span class="nv">$RUN_METADATA_DIR</span><span class="s2">/chaincode.json&quot;</span> &gt; <span class="s2">&quot;</span><span class="nv">$CORE_TLS_CLIENT_CERT_FILE</span><span class="s2">&quot;</span>
jq -r .client_key  <span class="s2">&quot;</span><span class="nv">$RUN_METADATA_DIR</span><span class="s2">/chaincode.json&quot;</span> &gt; <span class="s2">&quot;</span><span class="nv">$CORE_TLS_CLIENT_KEY_FILE</span><span class="s2">&quot;</span>
jq -r .root_cert   <span class="s2">&quot;</span><span class="nv">$RUN_METADATA_DIR</span><span class="s2">/chaincode.json&quot;</span> &gt; <span class="s2">&quot;</span><span class="nv">$CORE_PEER_TLS_ROOTCERT_FILE</span><span class="s2">&quot;</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="k">$(</span>jq -r .client_cert <span class="s2">&quot;</span><span class="nv">$RUN_METADATA_DIR</span><span class="s2">/chaincode.json&quot;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ENABLED</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>
<span class="k">fi</span>

<span class="c1"># exec the chaincode to replace the script with the chaincode process</span>
<span class="nb">exec</span> <span class="s2">&quot;</span><span class="nv">$BUILD_OUTPUT_DIR</span><span class="s2">/chaincode&quot;</span> -peer.address<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>jq -r .peer_address <span class="s2">&quot;</span><span class="nv">$ARTIFACTS</span><span class="s2">/chaincode.json&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="configuring-external-builders-and-launchers">
<span id="configuring-external-builders-and-launchers"></span><h2>Configuring external builders and launchers<a class="headerlink" href="#configuring-external-builders-and-launchers" title="Permalink to this headline">¶</a></h2>
<p>Configuring the peer to use external builders involves adding an externalBuilder element under the chaincode configuration block in the  <code class="docutils literal notranslate"><span class="pre">core.yaml</span></code> that defines external builders. Each external builder definition must include a name (used for logging) and the path to parent of the <code class="docutils literal notranslate"><span class="pre">bin</span></code> directory containing the builder scripts.</p>
<p>An optional list of environment variable names to propagate from the peer when invoking the external builder scripts can also be provided.</p>
<p>The following example defines two external builders:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">chaincode</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">externalBuilders</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-golang-builder</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/builders/golang</span>
    <span class="l l-Scalar l-Scalar-Plain">environmentWhitelist</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">GOPROXY</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">GONOPROXY</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">GOSUMDB</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">GONOSUMDB</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">noop-builder</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/builders/binary</span>
</pre></div>
</div>
<p>In this example, the implementation of “my-golang-builder” is contained within the <code class="docutils literal notranslate"><span class="pre">/builders/golang</span></code> directory and its build scripts are located in <code class="docutils literal notranslate"><span class="pre">/builders/golang/bin</span></code>. When the peer invokes any of the build scripts associated with “my-golang-builder”, it will propagate only the values of the environment variables in the whitelist.</p>
<p>Note: The following environment variables are always propagated to external builders:</p>
<ul class="simple">
<li>LD_LIBRARY_PATH</li>
<li>LIBPATH</li>
<li>PATH</li>
<li>TMPDIR</li>
</ul>
<p>When an <code class="docutils literal notranslate"><span class="pre">externalBuilder</span></code> configuration is present, the peer will iterate over the list of builders in the order provided, invoking <code class="docutils literal notranslate"><span class="pre">bin/detect</span></code> until one completes successfully. If no builder completes <code class="docutils literal notranslate"><span class="pre">detect</span></code> successfully, the peer will fallback to using the legacy Docker build process implemented within the peer. This means that external builders are completely optional.</p>
<p>In the example above, the peer will attempt to use “my-golang-builder”, followed by “noop-builder”, and finally the peer internal build process.</p>
</div>
<div class="section" id="chaincode-packages">
<span id="chaincode-packages"></span><h2>Chaincode packages<a class="headerlink" href="#chaincode-packages" title="Permalink to this headline">¶</a></h2>
<p>As part of the new lifecycle introduced with Fabric 2.0, the chaincode package format changed from serialized protocol buffer messages to a gzip compressed POSIX tape archive. Chaincode packages created with <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">lifecycle</span> <span class="pre">chaincode</span> <span class="pre">package</span></code> use this new format.</p>
<div class="section" id="lifecycle-chaincode-package-contents">
<span id="lifecycle-chaincode-package-contents"></span><h3>Lifecycle chaincode package contents<a class="headerlink" href="#lifecycle-chaincode-package-contents" title="Permalink to this headline">¶</a></h3>
<p>A lifecycle chaincode package contains two files. The first file, <code class="docutils literal notranslate"><span class="pre">code.tar.gz</span></code> is a gzip compressed POSIX tape archive. This file includes the source artifacts for the chaincode. Packages created by the peer CLI will place the chaincode implementation source under the <code class="docutils literal notranslate"><span class="pre">src</span></code> directory and chaincode metadata (like CouchDB indexes) under the <code class="docutils literal notranslate"><span class="pre">META-INF</span></code> directory.</p>
<p>The second file, <code class="docutils literal notranslate"><span class="pre">metadata.json</span></code> is a JSON document with three keys:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">type</span></code>: the chaincode type (e.g. GOLANG, JAVA, NODE)</li>
<li><code class="docutils literal notranslate"><span class="pre">path</span></code>: for go chaincode, the GOPATH or GOMOD relative path to the main chaincode package; undefined for other types</li>
<li><code class="docutils literal notranslate"><span class="pre">label</span></code>: the chaincode label that is used to generate the package-id by which the package is identified within the new chaincode lifecycle process.</li>
</ul>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">type</span></code> and <code class="docutils literal notranslate"><span class="pre">path</span></code> fields are only utilized by docker platform builds.</p>
</div>
<div class="section" id="chaincode-packages-and-external-builders">
<span id="chaincode-packages-and-external-builders"></span><h3>Chaincode packages and external builders<a class="headerlink" href="#chaincode-packages-and-external-builders" title="Permalink to this headline">¶</a></h3>
<p>When a chaincode package is installed to a peer, the contents of <code class="docutils literal notranslate"><span class="pre">code.tar.gz</span></code> and <code class="docutils literal notranslate"><span class="pre">metadata.json</span></code> are not processed prior to calling external builders, except for the <code class="docutils literal notranslate"><span class="pre">label</span></code> field that is used by the new lifecycle process to compute the package id. This affords users a great deal of flexibility in how they package source and metadata that will be processed by external builders and launchers.</p>
<p>For example, a custom chaincode package could be constructed that contains a pre-compiled, implementation of chaincode in <code class="docutils literal notranslate"><span class="pre">code.tar.gz</span></code> with a <code class="docutils literal notranslate"><span class="pre">metadata.json</span></code> that allows a <em>binary buildpack</em> to detect the custom package, validate the hash of the binary, and run the program as chaincode.</p>
<p>Another example would be a chaincode package that only contains state database index definitions and the data necessary for an external launcher to connect to a running chaincode server. In this case, the <code class="docutils literal notranslate"><span class="pre">build</span></code> process would simply extract the metadata from the process and <code class="docutils literal notranslate"><span class="pre">release</span></code> would present it to the peer.</p>
<p>The only requirements are that <code class="docutils literal notranslate"><span class="pre">code.tar.gz</span></code> can only contain regular file and directory entries, and that the entries cannot contain paths that would result in files being written outside of the logical root of the chaincode package.</p>
<!---
Licensed under Creative Commons Attribution 4.0 International License https://creativecommons.org/licenses/by/4.0/
--></div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cc_service.html" class="btn btn-neutral float-right" title="Chaincode as an external service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="metrics_reference.html" class="btn btn-neutral" title="Metrics Reference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2020.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'master',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>